{% extends "govuk-prototype-kit/layouts/unbranded.html" %}

{% block pageTitle %}
AI Search â€“ GOV.UK Prototype Kit
{% endblock %}

{% block header %}
{% include "includes/header-mobile-new.njk" %}
{% endblock %}

{% block content %}

<style>
    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #005ea5;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 10px auto;
        display: block;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .thinking-text {
        display: block;
        text-align: center;
        margin-top: 10px;
        color: #505a5f;
    }

    .search-result {
        margin-top: 30px;
        padding: 20px;
        border: 1px solid #f3f3f3;
        border-radius: 5px;
        background: #fff;
        font-family: "Source Sans Pro", Arial, sans-serif;
    }

    .search-result a {
        color: #1d70b8;
        text-decoration: underline;
        font-size: 19px;
    }

    .search-result h1,
    .search-result h2,
    .search-result h3,
    .search-result h4 {
        font-size: 24px;
        margin-bottom: 15px;
    }

    .search-result li {
        font-size: 19px;
        margin-bottom: 10px;
    }

    .search-result p {
        font-size: 19px;
        margin-bottom: 15px;
    }

    .search-box {
        margin-bottom: 30px;
    }

    .result-container {
        display: none;
    }
</style>

<body class="govuk-template__body pillar--none">
    <div class="govuk-width-container">
        <p></p>
    </div>

    <div class="govuk-breadcrumbs">
        <ol class="govuk-breadcrumbs__list">
            <li class="govuk-breadcrumbs__list-item">
                <a class="govuk-breadcrumbs__link" href="/new/index">Home</a>
            </li>
            <li class="govuk-breadcrumbs__list-item" aria-current="page">
                AI Search
            </li>
        </ol>
    </div>

    <main class="govuk-main-wrapper">
        <div class="govuk-grid-row">
            <div class="govuk-grid-column-three-quarters">
                <h1 class="govuk-heading-l" style="font-family: 'Source Sans Pro', sans-serif;">
                    Find a commercial agreement for your procurement
                </h1>



                <div class="govuk-inset-text">
                    <p class="govuk-body">Tell us what you need to buy and we will suggest a commercial agreement.
                        For example: "We are from the NHS and need to hire temporary staff. Which
                        agreement can we use?"</p>

                </div>

                <p class="govuk-body">You can also ask specific questions about these agreements:</p>

                <ul class="govuk-list govuk-list--bullet">
                    <li>RM1043.8 Digital Specialists and Programmes</li>
                    <li>RM6098 Technology Products & Associated Services 2</li>
                    <li>RM6187 Management Consultancy Framework Three (MCF3)</li>
                    <li>RM6116 Network Services 3</li>
                    <li>RM6264 Facilities Management and Workplace Services DPS</li>
                </ul>


                <!-- Search input container -->
                <div class="govuk-form-group search-box">
                    <form class="search-form">
                        <div class="govuk-grid-row">
                            <div class="govuk-grid-column-full">
                                <h2 class="govuk-heading-m">Search query</h2>
                                <div id="search-hint" class="govuk-hint">
                                    <p class="govuk-body">Example: "How do I buy from RM1043.8?"</p>
                                </div>

                                <textarea class="govuk-textarea govuk-!-margin-bottom-3" id="search-input"
                                    name="search-query" rows="2" aria-describedby="search-hint"></textarea>

                                <p class="govuk-body"><span class="govuk-!-font-weight-bold">Important:</span> This AI
                                    tool may sometimes give incorrect information. Always check recommendations with
                                    official CCS documentation.</p>

                                <p class="govuk-body">By using this AI search tool, you agree to our <a
                                        href="/new/terms" class="govuk-link">terms and conditions</a>.</p>

                                <button class="govuk-button" data-module="govuk-button" type="submit">
                                    Submit question
                                </button>
                            </div>
                        </div>
                    </form>

                </div>



                <!-- Loading indicator -->
                <div id="loading-container" style="display: none; text-align: center; margin: 30px 0;">
                    <div class="spinner"></div>
                    <span class="govuk-body thinking-text">Processing your search...</span>
                </div>

                <!-- Result container -->
                <div id="result-container" class="result-container">
                    <h2 class="govuk-heading-m">Search Results</h2>
                    <div id="search-result" class="search-result"></div>
                </div>

                <script>
                    document.addEventListener('DOMContentLoaded', function () {
                        const form = document.querySelector('.search-form');
                        const input = document.querySelector('#search-input');
                        const resultContainer = document.querySelector('#result-container');
                        const searchResult = document.querySelector('#search-result');
                        const loadingContainer = document.querySelector('#loading-container');

                        async function getAIResponse(query) {
                            try {
                                const response = await fetch('https://azd-uks-ai-webpilot-intelligentsearch-api-a3ewg3deabbmasab.uksouth-01.azurewebsites.net/search', {
                                    method: 'POST',
                                    headers: {
                                        'X-API-Key': 'web-intelligentSearchNS-20250403',
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({ query: query })
                                });

                                if (!response.ok) {
                                    throw new Error('API request failed');
                                }

                                const data = await response.json();
                                // Clean and process the response text
                                let processedHtml = data.answer_html
                                    // Remove code block markers and any extra whitespace
                                    .replace(/```html\s*/g, '')
                                    .replace(/```\s*/g, '')
                                    .replace(/^\s+|\s+$/g, '')
                                    // Handle RM numbers with or without parentheses
                                    .replace(
                                        /\(?(RM\d+(?:\.\d+)?)\)?/g,
                                        match => {
                                            // Remove parentheses if they exist
                                            const rmNumber = match.replace(/[()]/g, '');
                                            return `<a href="https://www.crowncommercial.gov.uk/agreements/${rmNumber}" class="govuk-link" target="_blank">${rmNumber}</a>`;
                                        }
                                    );

                                // Wrap the content in proper HTML structure
                                processedHtml = `<div class="govuk-body">${processedHtml}</div>`;
                                return processedHtml;
                            } catch (error) {
                                console.error('Error:', error);
                                return '<p class="govuk-body govuk-!-font-weight-bold">I can\'t answer that.</p><p class="govuk-body">Please focus your request on finding a commercial agreement or asking about a specific one.</p><p class="govuk-body">Example: "I need to purchase new laptops for a school. Which agreement can we use?" or "What are the key benefits of using RM6098?"</p>';
                            }
                        }

                        async function handleSearch(query) {
                            if (query) {
                                // Show loading spinner
                                loadingContainer.style.display = 'block';
                                resultContainer.style.display = 'none';

                                try {
                                    // Get AI response
                                    const aiResponseText = await getAIResponse(query);

                                    // Hide loading spinner
                                    loadingContainer.style.display = 'none';

                                    // Display the result
                                    searchResult.innerHTML = aiResponseText;
                                    resultContainer.style.display = 'block';

                                    // Update URL with query parameter (without page reload)
                                    const url = new URL(window.location);
                                    url.searchParams.set('search-query', query);
                                    window.history.pushState({}, '', url);

                                } catch (error) {
                                    console.error('Error:', error);
                                    loadingContainer.style.display = 'none';
                                    searchResult.innerHTML = '<p class="govuk-body govuk-!-font-weight-bold">I can\'t answer that.</p><p class="govuk-body">Please focus your request on finding a commercial agreement or asking about a specific one.</p><p class="govuk-body">Example: "I need to purchase new laptops for a school. Which agreement can we use?" or "What are the key benefits of using RM6098?"</p>';
                                    resultContainer.style.display = 'block';
                                }
                            }
                        }

                        // Handle form submissions
                        form.addEventListener('submit', function (e) {
                            e.preventDefault();
                            handleSearch(input.value.trim());
                        });

                        // Handle Enter key in textarea
                        input.addEventListener('keydown', function (e) {
                            // Check if it's the Enter key and Shift is not pressed
                            if (e.key === 'Enter' && !e.shiftKey) {
                                e.preventDefault(); // Prevent new line
                                handleSearch(input.value.trim());
                            }
                        });

                        // Check for URL parameter and handle initial query
                        const urlParams = new URLSearchParams(window.location.search);
                        const searchQuery = urlParams.get('search-query');

                        if (searchQuery) {
                            input.value = searchQuery;
                            handleSearch(searchQuery);
                        }
                    });
                </script>
            </div>

            <!-- Sidebar -->
            <aside class="govuk-grid-column-one-quarter">
                <div class="apollo-enclosure" style="background-color: #9B1A47; color: #ffffff; margin-bottom: 10px;">
                    <h2 class="aside__heading">Help us make this service better for you</h2>
                    <p> <a class="govuk-link" style="color: #ffffff; font-weight: 600;" href="/survey">Give
                            feedback on how we can improve this service.
                        </a></p>
                </div>

                <div class="apollo-enclosure apollo-enclosure--padded event-detail__aside__inner">
                    <h2 class="aside__heading">Related content</h2>
                    <ul class="govuk-list">
                        <li>
                            <a href="#" class="govuk-link">How to use AI search effectively</a>
                        </li>
                        <li>
                            <a href="#" class="govuk-link">Understanding AI in public sector procurement</a>
                        </li>
                    </ul>
                </div>
            </aside>
        </div>
    </main>
</body>
{% endblock %}

{% block footer %}
{% include "includes/footer.njk" %}
{% endblock %}